<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>狼人杀对局观战面板</title>
    <style>
        body {
            font-family: "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f4f6fa;
            color: #1f2933;
        }
        header {
            background: #1f6feb;
            color: #fff;
            padding: 16px 24px;
        }
        header h1 {
            margin: 0 0 8px;
            font-size: 20px;
        }
        main {
            padding: 24px;
            max-width: 960px;
            margin: 0 auto;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 24px;
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
        }
        label {
            font-weight: 600;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            font-size: 14px;
        }
        button {
            background: #1f6feb;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .match-meta {
            background: #fff;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
        }
        .list {
            list-style: none;
            padding: 0;
            margin: 8px 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .list li {
            padding: 4px 8px;
            border-radius: 999px;
            background: #e2e8f0;
            font-size: 13px;
        }
        .round {
            background: #fff;
            margin-bottom: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.05);
        }
        .round-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .event {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            gap: 4px;
        }
        .event:last-child {
            border-bottom: none;
        }
        .event-player {
            font-weight: 600;
        }
        .event-content {
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .empty {
            text-align: center;
            color: #64748b;
            padding: 48px 16px;
            background: #fff;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <header>
        <h1>狼人杀对局观战面板</h1>
        <p>实时查看各位玩家在讨论阶段的发言。</p>
    </header>
    <main>
        <section class="controls">
            <label for="matchSelect">对局</label>
            <select id="matchSelect"></select>
            <button id="refreshBtn">立即刷新</button>
            <span id="statusText">加载中...</span>
        </section>

        <section class="match-meta" id="matchMeta" hidden>
            <div><strong>当前阶段：</strong><span id="phaseText">-</span></div>
            <div><strong>当前轮次：</strong><span id="roundText">-</span></div>
            <div>
                <strong>存活玩家：</strong>
                <ul class="list" id="aliveList"></ul>
            </div>
            <div>
                <strong>出局玩家：</strong>
                <ul class="list" id="deadList"></ul>
            </div>
        </section>

        <section id="logContainer">
            <div class="empty" id="emptyState">暂无发言记录</div>
        </section>
    </main>

    <script>
        const matchSelect = document.getElementById('matchSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusText = document.getElementById('statusText');
        const matchMeta = document.getElementById('matchMeta');
        const phaseText = document.getElementById('phaseText');
        const roundText = document.getElementById('roundText');
        const aliveList = document.getElementById('aliveList');
        const deadList = document.getElementById('deadList');
        const logContainer = document.getElementById('logContainer');
        const emptyState = document.getElementById('emptyState');

        let currentMatch = null;
        let autoRefreshTimer = null;

        function setStatus(message, type = 'info') {
            statusText.textContent = message;
            statusText.style.color = type === 'error' ? '#dc2626' : '#1f2933';
        }

        function clearChildren(node) {
            while (node.firstChild) {
                node.removeChild(node.firstChild);
            }
        }

        async function loadMatches() {
            setStatus('加载对局列表...');
            try {
                const response = await fetch('/api/matches');
                if (!response.ok) throw new Error('列表接口错误');
                const data = await response.json();
                populateMatches(data.matches || []);
            } catch (err) {
                console.error(err);
                setStatus('获取对局列表失败', 'error');
            }
        }

        function populateMatches(matches) {
            clearChildren(matchSelect);
            if (!matches.length) {
                const option = document.createElement('option');
                option.textContent = '暂无进行中的对局';
                option.value = '';
                matchSelect.appendChild(option);
                currentMatch = null;
                renderMatch(null);
                setStatus('等待新对局...');
                return;
            }

            matches.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = item.match_id;
                option.textContent = `#${index + 1} / ${item.match_id.slice(0, 8)}`;
                matchSelect.appendChild(option);
            });

            const nextMatch = currentMatch && matches.some(m => m.match_id === currentMatch)
                ? currentMatch
                : matches[0].match_id;
            matchSelect.value = nextMatch;
            currentMatch = nextMatch;
            setStatus('对局列表更新完成');
            loadMatch(nextMatch);
        }

        async function loadMatch(matchId) {
            if (!matchId) {
                renderMatch(null);
                return;
            }
            setStatus('拉取发言记录...');
            try {
                const response = await fetch(`/api/matches/${matchId}/speech-log`);
                if (!response.ok) throw new Error('日志接口错误');
                const data = await response.json();
                renderMatch(data);
                setStatus('最新数据已同步');
            } catch (err) {
                console.error(err);
                setStatus('获取发言记录失败', 'error');
            }
        }

        function renderMatch(match) {
            if (!match) {
                matchMeta.hidden = true;
                emptyState.style.display = 'block';
                clearChildren(logContainer);
                logContainer.appendChild(emptyState);
                return;
            }

            matchMeta.hidden = false;
            phaseText.textContent = match.phase || '-';
            roundText.textContent = match.round || '-';

            renderPlayerList(aliveList, match.alive_players || []);
            renderPlayerList(deadList, match.dead_players || []);

            const grouped = groupByRound(match.speech_log || []);
            clearChildren(logContainer);

            if (!grouped.size) {
                logContainer.appendChild(emptyState);
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            grouped.forEach((events, roundKey) => {
                const roundCard = document.createElement('article');
                roundCard.className = 'round';

                const header = document.createElement('div');
                header.className = 'round-header';
                const title = document.createElement('span');
                title.textContent = `第 ${roundKey} 轮`;
                const count = document.createElement('span');
                count.textContent = `${events.length} 条发言`;
                header.append(title, count);
                roundCard.appendChild(header);

                events.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'event';

                    const player = document.createElement('span');
                    player.className = 'event-player';
                    player.textContent = `玩家 ${event.player_id} (${event.role})`;

                    const phase = document.createElement('span');
                    phase.className = 'event-phase';
                    phase.textContent = `${event.phase || ''} · ${new Date(event.timestamp).toLocaleTimeString()}`;

                    const content = document.createElement('div');
                    content.className = 'event-content';
                    content.textContent = event.content;

                    eventEl.append(player, phase, content);
                    roundCard.appendChild(eventEl);
                });

                logContainer.appendChild(roundCard);
            });
        }

        function renderPlayerList(target, players) {
            clearChildren(target);
            if (!players.length) {
                const placeholder = document.createElement('li');
                placeholder.textContent = '-';
                target.appendChild(placeholder);
                return;
            }
            players.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                target.appendChild(li);
            });
        }

        function groupByRound(events) {
            const map = new Map();
            events.forEach(event => {
                const round = event.round ?? '未知';
                if (!map.has(round)) {
                    map.set(round, []);
                }
                map.get(round).push(event);
            });
            return map;
        }

        matchSelect.addEventListener('change', event => {
            currentMatch = event.target.value;
            loadMatch(currentMatch);
        });

        refreshBtn.addEventListener('click', () => {
            if (currentMatch) {
                loadMatch(currentMatch);
            } else {
                loadMatches();
            }
        });

        function scheduleAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            autoRefreshTimer = setInterval(() => {
                if (currentMatch) {
                    loadMatch(currentMatch);
                } else {
                    loadMatches();
                }
            }, 5000);
        }

        loadMatches().then(scheduleAutoRefresh);
    </script>
</body>
</html>
